{% extends "base.html" %}
{% load static %}
{% load tz %}


{% block content %}
<div class="container-fluid mt-4">

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <div>
            <h2 class="fw-bold text-primary mb-0">Auto Trading Bot</h2>
            <p class="text-muted">Monitor multi-coin strategies and performance in real-time</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'start_bot' %}">
                <button id="startBotBtn" class="btn btn-success">
                    <i class="bi bi-play-fill"></i> Start Bot
                </button>
            </a>
            <a href="{% url 'stop_bot' %}">
                <button id="stopBotBtn" class="btn btn-danger">
                    <i class="bi bi-stop-fill"></i> Stop Bot
                </button>
            </a>
        </div>
    </div>

    <!-- Status Card -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">Current Status:</h5>
            {% if bot_status.is_running %}
            <span id="botStatus" class="badge bg-success px-3 py-2 fs-6">Running</span>
            {% else %}
            <span id="botStatus" class="badge bg-danger px-3 py-2 fs-6">Stopped</span>
            {% endif %}
        </div>
    </div>

    <!-- Predictions Table -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
            <h5 class="fw-bold mb-0">Coin Predictions</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-primary">
                        <tr>
                            <th>Checked At</th> <!-- New column -->
                            <th>Coin</th>
                            <th>Signal</th>
                            <th>Price</th>
                            <th>EMA</th>
                            <th>RSI</th>
                            <th>Volume Spike</th>
                            <th>Next Check</th>
                        </tr>
                    </thead>
                    <tbody>
    {% for prediction in predictions %}
    <tr>
        <!-- Checked At -->
        <td>
            {{ prediction.timestamp|timezone:"Asia/Karachi"|date:"d-M-Y h:i A" }}
        </td>

        <!-- Coin -->
        <td>{{ prediction.coin }}</td>

        <!-- Signal -->
        <td>
            {% if prediction.signal == "BUY" %}
                <span class="badge bg-success">{{ prediction.signal }}</span>
            {% elif prediction.signal == "SELL" %}
                <span class="badge bg-danger">{{ prediction.signal }}</span>
            {% else %}
                <span class="badge bg-secondary">{{ prediction.signal }}</span>
            {% endif %}
        </td>

        <!-- Price -->
        <td>${{ prediction.price|floatformat:2 }}</td>

        <!-- EMA200 -->
        <td>
            {% if prediction.ema200 %}
                {{ prediction.ema200|floatformat:2 }}
            {% else %}
                N/A
            {% endif %}
        </td>

        <!-- RSI -->
        <td>
            {% if prediction.rsi %}
                {{ prediction.rsi|floatformat:2 }}
            {% else %}
                N/A
            {% endif %}
        </td>

        <!-- Volume Spike -->
        <td>{{ prediction.volume_spike|yesno:"Yes,No" }}</td>

        <!-- Next Check -->
        <td>
            {% if prediction.next_check %}
                {{ prediction.next_check|timezone:"Asia/Karachi"|date:"d-M-Y h:i A" }}
            {% else %}
                N/A
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="8">No predictions yet. Start the bot to generate signals.</td>
    </tr>
    {% endfor %}
</tbody>

                </table>


            </div>
        </div>
    </div>

</div>

<!-- Messages / Toasts -->
<div id="messagesContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    {% if messages %}
    {% for message in messages %}
    <div class="toast align-items-center 
                        {% if bot_status.is_running %}
                            text-bg-success
                        {% else %}
                            text-bg-danger
                        {% endif %}
                        border-0 show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">{{ message }}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    {% endfor %}
    {% endif %}
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Automatically hide toasts after 3 seconds
    document.addEventListener("DOMContentLoaded", () => {
        const toastElList = [].slice.call(document.querySelectorAll('.toast'));
        toastElList.map(toastEl => new bootstrap.Toast(toastEl, { delay: 3000, autohide: true }).show());
    });
</script>

{% endblock %}