{% extends "base.html" %}

{% block dashboard_active %}active{% endblock %}

{% block content %}
<div class="row">
    <!-- LEFT SIDEBAR (Quick Actions) -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white fw-bold">
                Quick Actions
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'start_trade' %}" class="list-group-item list-group-item-action">‚úÖ Start Algorithm</a>
                <a href="{% url 'stop_trade' %}" class="list-group-item list-group-item-action">‚èπÔ∏è Stop Algorithm</a>
                <a href="{% url 'strategies' %}" class="list-group-item list-group-item-action">‚öôÔ∏è Settings</a>
                <a href="/notifications  /" class="list-group-item list-group-item-action">üîî Notifications</a>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD AREA -->
    <div class="col-lg-9">
        <!-- SUMMARY CARDS -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Algo Status</h6>
                        {% if bot_status.is_running %}
                            <h5 class="text-success fw-bold">Running</h5>
                        {% else %}
                            <h5 class="text-danger fw-bold">Stopped</h5>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Last Signal</h6>
                        {% if last_trade %}
                            <h5 class="fw-bold">{{ last_trade.action }} {{ last_trade.coin }}</h5>
                        {% else %}
                            <h5 class="fw-bold">N/A</h5>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">Balance / Equity</h6>
                        <h5 class="fw-bold">${{ balance|floatformat:2 }}</h5>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted">PnL Today</h6>
                        <h5 class="{% if pnl_today >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                            {% if pnl_today >= 0 %}+{% else %}-{% endif %}${{ pnl_today|floatformat:2 }}
                        </h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS / ANALYTICS -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white fw-bold">
                üìà Charts & Analytics
            </div>
            <div class="card-body">
                <p class="text-muted">Equity Curve & PnL Overview</p>
                <canvas id="equityChart" height="200"></canvas>
                <canvas id="pnlChart" height="200" class="mt-4"></canvas>
            </div>
        </div>

        <!-- OPEN TRADES TABLE -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white fw-bold">
                üìã Open Trades
            </div>
            <div class="card-body">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>PnL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in open_trades %}
                        <tr>
                            <td>{{ trade.id }}</td>
                            <td>{{ trade.coin }}</td>
                            <td>
                                <span class="badge {% if trade.action == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ trade.action }}
                                </span>
                            </td>
                            <td>{{ trade.quantity|default:"N/A" }}</td>
                            <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {% if trade.pnl >= 0 %}+{% else %}-{% endif %}${{ trade.pnl|default:0|floatformat:2 }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">No open trades</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Charts Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prepare equity and pnl data from Django context
    const equityData = {{ equity_curve|safe }};
    const pnlData = {{ monthly_pnl|safe }};
    const pnlColors = pnlData.map(val => val >= 0 ? '#28A745' : '#DC3545');

    // Equity Curve Chart
    new Chart(document.getElementById('equityChart'), {
        type: 'line',
        data: {
            labels: {{ equity_labels|safe }},
            datasets: [{
                label: 'Equity',
                data: equityData,
                borderColor: '#007BFF',
                fill: false,
                tension: 0.2
            }]
        },
        options: { responsive: true }
    });

    // Monthly PnL Chart
    new Chart(document.getElementById('pnlChart'), {
        type: 'bar',
        data: {
            labels: {{ pnl_labels|safe }},
            datasets: [{
                label: 'PnL ($)',
                data: pnlData,
                backgroundColor: pnlColors
            }]
        },
        options: { responsive: true }
    });
</script>
{% endblock %}
